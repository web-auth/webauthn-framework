Webauthn Symfony Bundle
=======================

# Installation

Install the bundle with Composer:

```sh
composer require web-auth/webauthn-symfony-bundle
```

If you are using Symfony Flex then the bundle will automatically be installed.
Otherwise you need to add it in your `AppKernel.php` file:

```php
<?php
// app/AppKernel.php

public function registerBundles()
{
    $bundles = [
        // ...
        new Webauthn\Bundle\WebauthnBundle(),
    ];
}
```

# Create Classes

This bundle needs classes and services to work:

* The credential object: it represents a credential from a security device,
* The Public Key Credential Source Repository: it will manage all credential sources,
* The token binding handler: security feature from the [RFC8471](https://tools.ietf.org/html/rfc8471).

## Public Key Credential Source

### The Entity

A Public Key Credential Source objects contains all the necessary information corresponds related to attested data received from a device.
Hereafter an example using Doctrine ORM. This entity can be enhanced and may also have a `name`, `description`, last usage timestamp or any other application specific fields to ease the management of this credential by the user or the administrator of your application.

Please note that no relationship between the credential and your user is present in this example. You may need to add such information (`OneToMany`/`ManyToOne` relationship).

This bundle also provides Doctrine types to ease the integration with your favorite ORM:
    * Class `Webauthn\AttestedCredentialData` => Doctrine Type `attested_credential_data`
    * Class `Webauthn\Base64BinaryDataType` => Doctrine Type `base64`
    * Class `Webauthn\PublicKeyCredentialDescriptor` => Doctrine Type `public_key_credential_descriptor`
    * Class `Webauthn\PublicKeyCredentialDescriptorCollection` => Doctrine Type `public_key_credential_descriptor_collection`

```php
<?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;
use Webauthn\PublicKeyCredentialSource as BasePublicKeyCredentialSource;

/**
 * @ORM\Table(name="public_key_credential_sources")
 * @ORM\Entity(repositoryClass="App\Repository\PublicKeyCredentialSourceRepository")
 */
class PublicKeyCredentialSource extends BasePublicKeyCredentialSource
{
    /**
     * @var string
     * @ORM\Id
     * @ORM\GeneratedValue
     * @ORM\Column(type="integer")
     */
    private $id;

    public function getId(): string
    {
        return $this->id;
    }
}
```

### The Repository

The repository will save and retrieve the credentials on-demand. It must implement `Webauthn\PublicKeyCredentialSourceRepository`.
To ease the integration into your application, the bundle provides a concrete class that uses Doctrine you can extend.

In this following example, we extend that class and add a method to get all credentials for a specific user handle.

Feel free to add your own methods.

```php
<?php

declare(strict_types=1);

namespace App\Repository;

use App\Entity\PublicKeyCredentialSource;
use Doctrine\Common\Persistence\ManagerRegistry;
use Webauthn\PublicKeyCredentialUserEntity;
use Webauthn\Bundle\Repository\PublicKeyCredentialSourceRepository as BasePublicKeyCredentialSourceRepository;

final class PublicKeyCredentialSourceRepository extends BasePublicKeyCredentialSourceRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, PublicKeyCredentialSource::class);
    }

    /**
     * @return PublicKeyCredentialSource[]
     */
    public function allForUser(PublicKeyCredentialUserEntity $user): array
    {
        $qb = $this->getEntityManager()->createQueryBuilder();

        return $qb->select('c')
            ->from($this->getClass(), 'c')
            ->where('c.userHandle = :user_handle')
            ->setParameter(':user_handle', $user->getId())
            ->getQuery()
            ->execute()
        ;
    }
}
```

## Public Key Credential User Entity

### The Entity

The user entity is the user in the Webauthn scope.
But in a Symfony application context, you don’t want to manage several user entities. 
This entity must extend the class `Webauthn\PublicKeyCredentialUserEntity`.

Hereafter an example of user entity class that implements the interface provided by the Symfony Security component.
Feel free to add the necessary setters as well as other fields you need (creation date, last update at…).

**Please note that the ID of the user IS NOT generated by Doctrine and must be a string.**
We highly recommend you to use UUIDs.

```php
<?php

declare(strict_types=1);

namespace App\Entity;

use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\ORM\Mapping as ORM;
use Symfony\Bridge\Doctrine\Validator\Constraints\UniqueEntity;
use Symfony\Component\Security\Core\User\UserInterface;
use Symfony\Component\Validator\Constraints as Assert;
use Webauthn\PublicKeyCredentialUserEntity;

/**
 * @ORM\Table(name="users")
 * @ORM\Entity(repositoryClass="App\Repository\UserRepository")
 * @UniqueEntity("name")
 */
class User extends PublicKeyCredentialUserEntity implements UserInterface
{
    /**
     * @ORM\Id
     * @ORM\Column(type="string", length=255)
     */
    protected $id;

    /**
     * @ORM\Column(type="string", length=255)
     * @Assert\Length(max = 100)
     */
    protected $name;

    /**
     * @ORM\Column(type="string", length=255)
     * @Assert\Length(max = 100)
     */
    protected $displayName;

    /**
     * @ORM\Column(type="array")
     */
    protected $roles;

    /**
     * @var PublicKeyCredentialSource[]
     * @ORM\ManyToMany(targetEntity="App\Entity\PublicKeyCredentialSource")
     * @ORM\JoinTable(name="users_user_handles",
     *      joinColumns={@ORM\JoinColumn(name="user_id", referencedColumnName="id")},
     *      inverseJoinColumns={@ORM\JoinColumn(name="user_handle", referencedColumnName="id", unique=true)}
     *      )
     */
    protected $publicKeyCredentialSources;

    public function __construct(string $id, string $name, string $displayName, array $roles)
    {
        parent::__construct($name, $id, $displayName);
        $this->roles = $roles;
        $this->publicKeyCredentialSources = new ArrayCollection();
    }

    public function getRoles(): array
    {
        return array_unique($this->roles + ['ROLE_USER']);
    }

    public function getPassword(): void
    {
    }

    public function getSalt(): void
    {
    }

    public function getUsername(): ?string
    {
        return $this->name;
    }

    public function eraseCredentials(): void
    {
    }

    /**
     * @return PublicKeyCredentialSource[]
     */
    public function getPublicKeyCredentialSources(): array
    {
        return $this->publicKeyCredentialSources->getValues();
    }
}
```

### The Repository

The repository must implement the interface `Webauthn\Bundle\Repository\PublicKeyCredentialUserEntityRepository`.
The following example uses Doctrine to create, persist or perform queries using the User objects created above.

```php
<?php

declare(strict_types=1);

namespace App\Repository;

use App\Entity\User;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepositoryInterface;
use Doctrine\Common\Persistence\ManagerRegistry;
use Doctrine\ORM\EntityManagerInterface;
use LogicException;
use Webauthn\PublicKeyCredentialUserEntity;
use Webauthn\Bundle\Repository\PublicKeyCredentialUserEntityRepository as BasePublicKeyCredentialUserEntityRepository;

final class UserRepository implements ServiceEntityRepositoryInterface, BasePublicKeyCredentialUserEntityRepository
{
    /**
     * @var EntityManagerInterface
     */
    private $manager;

    public function __construct(ManagerRegistry $registry)
    {
        $manager = $registry->getManagerForClass(User::class);

        if (null === $manager) {
            throw new LogicException(sprintf(
                'Could not find the entity manager for class "%s". Check your Doctrine configuration to make sure it is configured to load this entity’s metadata.',
                User::class
            ));
        }

        $this->manager = $manager;
    }

    public function save(User $user): void
    {
        $this->manager->persist($user);
        $this->manager->flush();
    }

    public function findOneByUsername(string $username): ?User
    {
        $qb = $this->manager->createQueryBuilder();

        return $qb->select('u')
            ->from(User::class, 'u')
            ->where('u.name = :name')
            ->setParameter(':name', $username)
            ->setMaxResults(1)
            ->getQuery()
            ->getOneOrNullResult()
        ;
    }

    public function findOneByUserHandle(string $userHandle): ?User
    {
        $qb = $this->manager->createQueryBuilder();

        return $qb->select('u')
            ->from(User::class, 'u')
            ->where('u.user_handle = :user_handle')
            ->setParameter(':user_handle', $userHandle)
            ->setMaxResults(1)
            ->getQuery()
            ->getOneOrNullResult()
        ;
    }
    
    public function createUserEntity(string $username,string $displayName,?string $icon) : PublicKeyCredentialUserEntity
    {
        return new User($username,$displayName,$icon);
    }
    
    public function saveUserEntity(PublicKeyCredentialUserEntity $userEntity) : void
    {
        $this->manager->persist($userEntity);
        $this->manager->flush();
    }
}
```
# Configuration
 
```yaml
webauthn:
    credential_repository: 'App\Repository\PublicKeyCredentialSourceRepository'
    user_repository: 'App\Repository\UserRepository' # Only mandatory in some use cases (e.g. with the firewall)
```

# Available Services

The bundle allows you to use the following public services:

* `Webauthn\PublicKeyCredentialLoader`
* `Webauthn\AuthenticatorAttestationResponseValidator`
* `Webauthn\AuthenticatorAssertionResponseValidator`
* `Webauthn\Bundle\Service\PublicKeyCredentialCreationOptionsFactory`
* `Webauthn\Bundle\Service\PublicKeyCredentialRequestOptionsFactory`

These services can be injected or retrieved from the Symfony container (`$container->get(PublicKeyCredentialLoader::class)`).
They will help you to register new credentials and authenticate users.

# Creation Request/Attestation Request Profiles

## Registering New Credentials

## User Authentication

# Android SafetyNet Support


# Token Binding Handler

The [RFC8471](https://tools.ietf.org/html/rfc8471) adds a security feature to bind the response from a security device with the current TLS session. With this feature, it is more complicated for an attacker to perform replay attacks.

As this feature is not fully supported by browsers and servers and implementations are very rare, a Token Binding Handler is present in the library and this bundle.
At the moment this feature is not supported by the library, but using this handler, you can decide the strategy to adopt if token binding is present in the security device responses.

Available handlers (Symfony services):

* Ignore: use `Webauthn\TokenBinding\IgnoreTokenBindingHandler` to ignore the Token Binding
* Error (default): use `Webauthn\TokenBinding\TokenBindingNotSupportedHandler` and throw an exception

See also [#2](https://github.com/web-auth/webauthn-framework/issues/2) for more information.

# Configure the Bundle

In your application configuration, you have to add a `webauthn` section:

```yaml
#...
webauthn:
    …
    token_binding_support_handler: 'Webauthn\TokenBinding\IgnoreTokenBindingHandler' # Default is 'Webauthn\TokenBinding\TokenBindingNotSupportedHandler'
```
